# SmartToDo 后端详细设计文档

## 1. 整体架构设计

系统采用基于 Java 的微服务架构，利用 Spring Cloud 生态系统构建高可用、可扩展的后台。

### 1.1 技术栈选型

- **开发语言**: Java 17
- **核心框架**: Spring Boot 3.x, Spring Cloud Alibaba (Nacos, Sentinel)
- **网关**: Spring Cloud Gateway
- **数据库**: MySQL 8.0 (主存储), Redis 7.0 (缓存/分布式锁)
- **消息队列**: RocketMQ 5.x (用于业务解耦、动态采集、异步通知)
- **AI 交互**: LangChain4j (Java 版 LangChain) + 阿里巴巴 DashScope (通义千问 Qwen)
- **持久层**: MyBatis Plus 
- **容器化**: Docker & Docker Compose 

### 1.2 微服务模块拆分

| 服务名称             | 职责描述                                                     |
| -------------------- | ------------------------------------------------------------ |
| **Auth Service**     | 基于 Spring Security + JWT 的身份认证与鉴权。                |
| **Task Service**     | 核心业务：清单/任务的分层管理，实现无限层级 Path 查询。      |
| **Activity Service** | 动态采集消费端，负责复杂上下文中动态记录的存储与查询。       |
| **AI Agent Service** | 接入阿里 DashScope，实现意图识别、任务自动拆解与同步。       |
| **Gateway Service**  | 基于 Spring Cloud Gateway，负责路由转发、鉴权拦截、流量染色。 |

## 2. 数据库设计

### 2.1 清单表 (lists) - 字段增强

- **icon**: 用于存储图标标识符（如 `fa-work`, `mdi-home`）。前端根据此字段渲染侧边栏清单图标。
- **color**: 存储 Hex 颜色值（如 `#FF5733`）。用于清单卡片高亮、图标着色，帮助用户快速视觉定位。

| 字段       | 类型         | 说明                                      |
| ---------- | ------------ | ----------------------------------------- |
| id         | bigint       | PK                                        |
| group_id   | bigint       | 所属清单分组 ID                           |
| name       | varchar(100) | 清单名称                                  |
| **color**  | varchar(7)   | **UI 用途：清单主题色/图标颜色**          |
| **icon**   | varchar(50)  | **UI 用途：前端渲染的图标 CSS 类名/标识** |
| sort_order | int          | 排序权重                                  |

### 2.2 任务表 (tasks) - 方案 B (路径枚举) 优化

采用 **路径枚举 (Path Enumeration)** 方案，增加 `path` 和 `depth` 字段，以支持高效的无限层级查询。

| 字段       | 类型         | 说明                                                     |
| ---------- | ------------ | -------------------------------------------------------- |
| id         | bigint       | PK                                                       |
| user_id    | bigint       | 用户 ID (索引)                                           |
| list_id    | bigint       | 所属清单 ID                                              |
| tg_id      | bigint       | 所属任务分组 ID                                          |
| parent_id  | bigint       | 直接父 ID (顶级为 0)                                     |
| **path**   | varchar(512) | **路径字符串：如 "0/1/5/12/" (包含所有祖先 ID，加索引)** |
| **depth**  | int          | **层级深度：0 为根任务，用于前端限制缩进或渲染**         |
| title      | varchar(255) | 任务标题                                                 |
| status     | varchar(20)  | 状态 (TODO, DONE)                                        |
| priority   | tinyint      | 优先级 (1-3)                                             |
| due_time   | datetime     | 截止时间                                                 |
| created_at | datetime     | 创建时间                                                 |

### 2.3 动态记录表 (activities) - 上下文增强

为了满足“用户在 LG -> L -> TG 中操作任务 T”的业务需求，此表进行了冗余设计，避免频繁关联查询。

| 字段           | 类型         | 说明                                        |
| -------------- | ------------ | ------------------------------------------- |
| id             | bigint       | PK                                          |
| user_id        | bigint       | 操作用户 ID                                 |
| user_name      | varchar(50)  | 用户快照名 (可选)                           |
| **lg_id**      | bigint       | 清单分组 ID                                 |
| **lg_name**    | varchar(100) | 清单分组快照名                              |
| **list_id**    | bigint       | 清单 ID                                     |
| **list_name**  | varchar(100) | 清单快照名                                  |
| **tg_id**      | bigint       | 任务分组 ID                                 |
| **tg_name**    | varchar(100) | 任务分组快照名                              |
| **task_id**    | bigint       | 任务 ID                                     |
| **task_title** | varchar(255) | 任务标题快照                                |
| action         | varchar(50)  | 操作类型 (CREATE, DELETE, COMPLETE, UPDATE) |
| created_at     | datetime     | 发生时间                                    |

## 3. 关键逻辑实现

### 3.1 方案 B 任务查询 (Path Enumeration)

- **查询所有子孙**: `SELECT * FROM tasks WHERE path LIKE '0/1/5/%'` (利用 `path` 索引)。
- **插入新任务**:
  1. 获取父任务的 `path` 和 `depth`。
  2. 新任务 `path` = `parent.path + parent.id + "/"`, `depth` = `parent.depth + 1`。
- **删除任务**: `DELETE FROM tasks WHERE path LIKE '.../%'` 可一键删除整棵子树。

### 3.2 消息驱动的动态系统 (RocketMQ)

1. **Producer (Task Service)**: 在执行增删改操作后，构建 `ActivityEvent` 消息发送至 RocketMQ 的 `TOPIC_ACTIVITY`。
2. **Consumer (Activity Service)**:
   - 订阅消息。
   - 消费时根据 ID 补全名称快照（或在消息中已包含快照）。
   - 存储至动态表，并通过 WebSocket (可选) 推送给前端。

### 3.3 AI Agent 集成 (LangChain4j + 阿里)

- **接入方式**: 使用 `langchain4j-dashscope` 依赖。
- **流程**:
  1. 用户在前端输入自然语言。
  2. `AI Agent Service` 接收请求，利用 LangChain4j 的 `AiServices` 定义业务接口。
  3. 调用通义千问 (Qwen) 进行意图解析（Intent Classification）和实体提取（NER）。
  4. 返回结构化 JSON，由后端判断是执行 `createTask` 还是 `planDecomposition`。

## 4. 接口规范简述

| 路径                      | 方法 | 描述                                             |
| ------------------------- | ---- | ------------------------------------------------ |
| `/v1/gateway/auth`        | ALL  | 统一鉴权入口                                     |
| `/v1/tasks/tree/{rootId}` | GET  | 获取某任务下的整棵子树 (方案 B 优势)             |
| `/v1/activities/stream`   | GET  | 获取增强上下文后的动态流 (支持根据 list_id 筛选) |
| `/v1/ai/chat`             | POST | 与 AI Agent 对话，下达任务指令                   |

## 5. Docker Compose 部署结构 

```
version: '3.8'
services:
  nacos:
    image: nacos/nacos-server:v2.2.1
    ports: ["8848:8848"]

  rocketmq-namesrv:
    image: apache/rocketmq:5.1.0
    command: sh mqnamesrv
    ports: ["9876:9876"]

  rocketmq-broker:
    image: apache/rocketmq:5.1.0
    command: sh mqbroker -n rocketmq-namesrv:9876
    depends_on: ["rocketmq-namesrv"]
    ports: ["10909:10909", "10911:10911"]

  task-service:
    build: ./services/task-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - ALIYUN_DASHSCOPE_API_KEY=${API_KEY}
```