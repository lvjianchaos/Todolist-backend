# 定义smart-todo项目专属网络
networks:
  smart-todo-network:
    driver: bridge

# 定义smart-todo项目专属数据卷
volumes:
  smart-todo-mysql-data:
  smart-todo-redis-data:
  smart-todo-nacos-data:

services:
  # 1. MySQL 服务（smart-todo项目数据存储）
  smart-todo-mysql:
    image: mysql:8.0.36
    container_name: smart-todo-mysql
    restart: always
    networks:
      - smart-todo-network
    volumes:
      - smart-todo-mysql-data:/var/lib/mysql
      - ./smart-todo-init.sql:/docker-entrypoint-initdb.d/smart-todo-init.sql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: smart_todo
      MYSQL_USER: smart_todo_user
      MYSQL_PASSWORD: smart_todo123
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    command:
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --lower_case_table_names=1
      --max_allowed_packet=128M


  # 2. Redis 服务（smart-todo项目缓存）
  smart-todo-redis:
    image: redis:7.2-alpine
    container_name: smart-todo-redis
    restart: always
    networks:
      - smart-todo-network
    volumes:
      - smart-todo-redis-data:/data
    environment:
      TZ: Asia/Shanghai
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes

  # 3. Nacos 服务（smart-todo项目注册中心/配置中心）
  smart-todo-nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: smart-todo-nacos
    environment:
      - MODE=standalone
      - JVM_XMS=256m
      - JVM_XMX=256m
      - NACOS_AUTH_ENABLE=false
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    networks:
      - smart-todo-network
    restart: always


  auth:
    build:
      context: ./auth
    container_name: smart_todo-auth
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=smart-todo-nacos:8848
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=smart-todo-nacos:8848
      - JAVA_OPTS=-Xms256m -Xmx256m
      - SMART_TODO_MYSQL_HOST=smart-todo-mysql
      - SMART_TODO_MYSQL_PORT=3306
    ports:
      - "8001:8001"
    depends_on:
      - smart-todo-nacos
    networks:
      - smart-todo-network

  task:
    build:
      context: ./task
    container_name: smart_todo-task
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=smart-todo-nacos:8848
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=smart-todo-nacos:8848
      - JAVA_OPTS=-Xms256m -Xmx256m
      - SMART_TODO_MYSQL_HOST=smart-todo-mysql
      - SMART_TODO_MYSQL_PORT=3306
    ports:
      - "8002:8002"
    depends_on:
      - smart-todo-nacos
    networks:
      - smart-todo-network

  activity:
    build:
      context: ./activity
    container_name: smart_todo-activity
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=smart-todo-nacos:8848
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=smart-todo-nacos:8848
      - JAVA_OPTS=-Xms256m -Xmx256m
      - SMART_TODO_MYSQL_HOST=smart-todo-mysql
      - SMART_TODO_MYSQL_PORT=3306
    ports:
      - "8003:8003"
    depends_on:
      - smart-todo-nacos
    networks:
      - smart-todo-network

  gateway:
    build:
      context: ./gateway
    container_name: smart_todo-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=smart-todo-nacos:8848
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=smart-todo-nacos:8848
      - JAVA_OPTS=-Xms256m -Xmx256m
    ports:
      - "8000:8000"
    depends_on:
      - smart-todo-nacos
      - auth
      - task
      - activity
      - ai-agent
    networks:
      - smart-todo-network

  ai-agent:
    build:
      context: ./ai-agent
    container_name: smart_todo-ai-agent
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=smart-todo-nacos:8848
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=smart-todo-nacos:8848
      - JAVA_OPTS=-Xms256m -Xmx256m
      - SMART_TODO_REDIS_HOST=smart-todo-redis
      - SMART_TODO_REDIS_PORT=6379
      - DEEPSEEK_BASE_URL=https://api.deepseek.com
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_MODEL=deepseek-chat
    ports:
      - "8004:8004"
    depends_on:
      - smart-todo-nacos
      - smart-todo-redis
    networks:
      - smart-todo-network
